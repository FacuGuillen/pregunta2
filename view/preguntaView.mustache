<main>
    <div id="timer-container">
        <div class="barra-fondo">
            <div class="barra-progreso"></div>
        </div>
    </div>
    <div class="contenedor-pregunta {{color}}">

        <form method="POST" action="/juego/responder" id="form-respuesta">
            <input type="hidden" name="id_pregunta" value="{{id_pregunta}}">
            <input type="hidden" name="respuesta" id="respuesta-default" value="">

            <h4 class="pregunta">{{pregunta}}</h4>

            <div class="respuestas">
                {{#respuestas}}
                    <button type="button" name="respuesta" value="{{id_respuesta}}" class="boton-respuesta" data-correcta="{{es_correcta}}">
                        {{respuesta}}
                    </button>
                {{/respuestas}}
            </div>
        </form>
    </div>

    <div class="contenedor-acciones">
        <button type="submit" id="boton-continuar" form="form-respuesta">Continuar</button>
        <button type="button" id="boton-reportar">Reportar pregunta</button>
    </div>

    <div id="modal-reportar" class="modal">
        <div class="modal-contenido">
            <p>¿Estás seguro de que quieres reportar esta pregunta?</p>
            <button id="confirmar-reportar">Confirmar</button>
            <button id="cancelar-reportar">Cancelar</button>
        </div>
    </div>

</main>

<script>
    let tiempo = 10;
    const barraProgreso = document.querySelector('.barra-progreso');
    const form = document.getElementById('form-respuesta');
    const duracionTotal = tiempo;
    const botones = document.querySelectorAll(".boton-respuesta");
    const botonContinuar = document.getElementById('boton-continuar');
    let tiempoAgotado = false;
    const botonReportar = document.getElementById('boton-reportar');
    const modal = document.getElementById('modal-reportar');
    const confirmarReportar = document.getElementById('confirmar-reportar');
    const cancelarReportar = document.getElementById('cancelar-reportar');
    const contenedorAcciones = document.querySelector('.contenedor-acciones'); // Nuevo

    const countdown = setInterval(() => {
        tiempo--;

        const porcentaje = (tiempo / duracionTotal) * 100;
        barraProgreso.style.width = porcentaje + '%';

        const color = calcularColor(tiempo, duracionTotal);
        barraProgreso.style.backgroundColor = color;

        if (tiempo <= 0) {
            clearInterval(countdown);
            tiempoAgotado = true;
            document.getElementById('respuesta-default').value = '';
            mostrarBotones();
            deshabilitarRespuestas();
            resaltarRespuestas();
        }
    }, 1000);

    botones.forEach(boton => {
        boton.addEventListener("click", () => {
            clearInterval(countdown);
            const idRespuesta = boton.value;
            document.getElementById('respuesta-default').value = idRespuesta;

            botonContinuar.textContent = 'Continuar';
            mostrarBotones();
            deshabilitarRespuestas();
            resaltarRespuestas(boton);
        });
    });

    if (tiempo <= 0) {
        clearInterval(countdown);
        tiempoAgotado = true;
        document.getElementById('respuesta-default').value = '';
        botonContinuar.textContent = 'Ver resultados';
        mostrarBotones();
        deshabilitarRespuestas();
        resaltarRespuestas();
    }

    function calcularColor(tiempoRestante, tiempoTotal) {
        const porcentaje = 1 - (tiempoRestante / tiempoTotal);

        const rojo = Math.round(76 + (244 - 76) * porcentaje);
        const verde = Math.round(175 - (175 - 67) * porcentaje);
        const azul = Math.round(80 - (80 - 54) * porcentaje);

        return `rgb(${rojo}, ${verde}, ${azul})`;
    }

    function mostrarBotones() {
        contenedorAcciones.style.visibility = 'visible';
    }

    function deshabilitarRespuestas() {
        botones.forEach(b => {
            b.disabled = true;
        });
    }

    function resaltarRespuestas(botonSeleccionado = null) {
        botones.forEach(b => {
            const esCorrecta = b.getAttribute('data-correcta') === '1';

            if (esCorrecta) {
                b.classList.add('correcta');
            } else if (botonSeleccionado && b === botonSeleccionado) {
                b.classList.add('incorrecta');
            } else if (!esCorrecta && b !== botonSeleccionado) {
                b.classList.add('no-seleccionada');
            }
        });
    }


    botonReportar.addEventListener('click', () => {
        modal.style.display = 'block';
    });

    cancelarReportar.addEventListener('click', () => {
        modal.style.display = 'none';
    });

    confirmarReportar.addEventListener('click', () => {
        fetch('/juego/reportar', {
            method: 'POST'
        })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ok') {
                        alert('Pregunta reportada con éxito');
                    } else {
                        alert('Error al reportar la pregunta');
                    }
                    modal.style.display = 'none';
                })
                .catch(error => {
                    console.error('Error:', error);
                    modal.style.display = 'none';
                });
    });

</script>